<!doctype html>
<html>
<head>
<script src="js/lib/atom.js"></script>
<script src="js/lib/glMatrix.js"></script>
<script src="js/lib/utils.js"></script>
<script src="js/player.js"></script>

<script>
(function () {
	var
		gl,
		viewportWidth,
		viewportHeight,
		player,
		length,
		program,
		vbo,
		ibo,
		texture;

	function onMove (e) {
		player.pointer(e.movementX, e.movementY);
	}

	window.onload = function () {
		player = new Player();

		var canvas = document.getElementById("canvas");
		viewportWidth = canvas.width;
		viewportHeight = canvas.height;
		gl = Utils.getContext(canvas);
		gl.clearColor(0, 0, 0, 1);
		gl.enable(gl.DEPTH_TEST);

		atom.dom(canvas).bind('click', function () {
			atom.pointerLock.request(canvas, onMove);
		});


		Utils.loadShaders(gl, [ 'fragment-indexes', 'vertex-indexes' ], function (shaders) {
			// create program object
			program = gl.createProgram();

			// attach our two shaders to the program
			gl.attachShader(program, shaders['vertex-indexes']);
			gl.attachShader(program, shaders['fragment-indexes']);

			// setup attributes (optional)
			gl.bindAttribLocation(program, 0, "aPosition");
			gl.bindAttribLocation(program, 1, "aNormal");
			gl.bindAttribLocation(program, 2, "aTexCoord");

			// linking
			gl.linkProgram(program);
			if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
				console.error(gl.getProgramInfoLog(program));
				return;
			}

			// setup uniforms (optional)
			gl.useProgram(program);
			gl.uniform1i(gl.getUniformLocation(program, "uTexture"), 0);

			// setup VBO
			// =================================================

			// define some vertexdata
			var vertices = [
				// position XYZ, normal XYZ, texcoord UV => 8 floats per vertex
				0, 1,    0.0,  0.6,  0.0,  0.8,   0, 0,
				1, 1,    0.0,  0.6,  0.0,  0.8,   1, 0,
				0, 0,    0.0,  0.0,  0.0,  1.0,   0, 1,
				1, 0,    0.0,  0.0,  0.6,  0.8,   1, 1,
				0, 1,    1.0,  0.6,  0.0,  0.8,   1, 0,
				1, 1,    1.0,  0.6,  0.0,  0.8,   0, 0,
				0, 0,    1.0,  0.0,  0.0,  1.0,   1, 1,
				1, 0,    1.0,  0.0,  0.6,  0.8,   0, 1
			];
			// we need also some indices because of this annoying Firefox-Bug:
			// https://bugzilla.mozilla.org/show_bug.cgi?id=521667
			var indices = [
				0,3,2, 0,1,3,
				1,5,3, 3,5,7,
				6,7,4, 7,5,4,
				2,3,6, 6,3,7,
				0,2,6, 0,6,4,
				0,4,1, 1,4,5

			];
			// create VBO and IBO
			vbo = gl.createBuffer();
			gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
			gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
			ibo = gl.createBuffer();
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo);
			gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);

			length  = indices.length;
			texture = loadTexture("wiki.png");

			atom.frame.add(draw);
		}.bind(this));
	};

	function loadTexture(filename) {
		// preparations
		var texture = gl.createTexture();
		gl.bindTexture(gl.TEXTURE_2D, texture);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
		var image = new Image();

		// register event handlers
		image.onload = function() {
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
			gl.generateMipmap(gl.TEXTURE_2D);
		};

		// request image from server
		image.src = filename;

		// return texture object (asynchronous loading, texture NOT available yet!)
		return texture;
	}

	function draw(time) {
		player.onTick(time);

		gl.viewport(0, 0, viewportWidth, viewportHeight);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT );

		// setup shader
		gl.useProgram(program);
		gl.enable  (gl.CULL_FACE);

		var mv = mat4.identity( mat4.create() );
		mat4.rotate ( mv, player.angleVertical, [1, 0, 0]);
		mat4.rotate ( mv, player.angleHorisontal, [0, 1, 0]);
		mat4.translate( mv, player.cameraVector );

		var pers = mat4.identity( mat4.create() );
		mat4.perspective(45, viewportWidth / viewportHeight, 0.1, 100.0, pers);

		gl.uniformMatrix4fv(gl.getUniformLocation(program, 'modelViewMatrix'), false, mv);
		gl.uniformMatrix4fv(gl.getUniformLocation(program, 'persMatrix'), false, pers);

		// setup interleaved VBO and IBO
		gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo);
		gl.enableVertexAttribArray(0);
		gl.enableVertexAttribArray(1);
		gl.enableVertexAttribArray(2);
		gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 8*4, 0*4); // position
		gl.vertexAttribPointer(1, 3, gl.FLOAT, false, 8*4, 3*4); // normal
		gl.vertexAttribPointer(2, 2, gl.FLOAT, false, 8*4, 6*4); // texcoord

		// setup texture
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, texture);

		// draw the buffer
		gl.drawElements(gl.TRIANGLES, length, gl.UNSIGNED_SHORT, 0);
	}
}());
</script>
</head>
	<body>
		<canvas id="canvas" width="512" height="512"></canvas>
	</body>
</html>